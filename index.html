<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Non Serviam: Driver's License “X” Marker Map</title>
	<meta name="description"
		content="Interactive map showing which U.S. states allow an 'X' gender marker on driver's licenses, with notes and sources." />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<link rel="stylesheet" href="style.css" />
</head>

<body>
	<header class="header-float">
		<div class="header-pill">
			<h1>Non Serviam</h1>
			<div class="sub">Non-Binary Driver's License “X” Marker Map</div>
		</div>
	</header>
	<div class="app" role="application">

		<aside class="sidebar" aria-label="Controls and legend">
			<section class="panel">
				<h2 class="title">Description</h2>
				<p>This map shows which U.S. states allow an <b>“X”</b> gender marker
					on driver's licenses.</p>
			</section>

			<section class="panel">
				<h2 class="legend-title">Legend</h2>
				<div class="legend" aria-label="Status legend">
					<div class="item"><span class="swatch swatch-allows-x"></span> allows_X</div>
					<div class="item"><span class="swatch swatch-no-x"></span> no_X</div>
					<div class="item"><span class="swatch swatch-unclear"></span> unclear_or_litigation</div>
				</div>
			</section>

			<section class="panel controls" aria-label="Filters">
				<h2 class="filter-title">Filter status</h2>
				<label><input type="checkbox" checked data-status="allows_X" /> Show allows_X</label>
				<label><input type="checkbox" checked data-status="no_X" /> Show no_X</label>
				<label><input type="checkbox" checked data-status="unclear_or_litigation" /> Show
					unclear_or_litigation</label>
				<div class="filter-buttons">
					<button class="btn" id="resetBtn" type="button">Reset View</button>
					<button class="btn" id="downloadBtn" type="button">Download filtered GeoJSON</button>
				</div>
			</section>
			<section class="panel">
				<details class="table" open>
					<summary class="table-summary">Table view</summary>
					<div class="table-container">
						<table id="dataTable" aria-describedby="updatedBadge">
							<thead>
								<tr>
									<th scope="col">State</th>
									<th scope="col">Status</th>
									<th scope="col">Allows X?</th>
									<th scope="col">Notes</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</details>
			</section>

			</section>
			<section class="panel">
				<div class="badge" id="updatedBadge">Updated: <span id="updatedDate">—</span></div>
			</section>


			<section class="foot">
				<p>⚠️ Educational use only, not legal advice.</p>
			</section>
		</aside>

		<main id="map" aria-label="Map of U.S. states">
			<div class="basemap-tint"></div>
		</main>
	</div>

	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script>
		// === Configuration ===
		const GEOJSON_URL = 'states-simplified.geojson';

		function getCss(name) {
			return getComputedStyle(document.documentElement).getPropertyValue(name)?.trim();
		}

		const STATUS_COLORS = {
			'allows_X': getCss('--color-allows-x') || getCss('--color-allows-x'),
			'no_X': getCss('--color-no-x') || getCss('--color-no-x'),
			'unclear_or_litigation': getCss('--color-unclear') || getCss('--color-unclear')
		};

		const map = L.map('map', {
			minZoom: 3,
			maxZoom: 10,
			zoomControl: true,
			preferCanvas: true,
		});

		map.setView([33.7490, -84.3880], 5);

		const USA_BOUNDS = [
			[24.396308, -125.0],
			[49.384358, -66.93457]
		];
		map.setMaxBounds(USA_BOUNDS);

		// const USA_BOUNDS = [
		// 	[24.396308, -125.0],
		// 	[49.384358, -66.93457]
		// ];
		// map.fitBounds(USA_BOUNDS, { padding: [12, 12] });

		L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
			attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
		})
			.setOpacity(0.7)
			.addTo(map);

		L.control.scale({
			position: 'bottomright', // 'topleft', 'topright', 'bottomleft', 'bottomright'
			imperial: false, // Show imperial units (miles, feet)
			metric: true // Show metric units (kilometers, meters)
		}

		).addTo(map);


		let statesLayer; // Leaflet GeoJSON layer
		let currentData; // raw GeoJSON for filtering & download

		const checkedStatuses = new Set(['allows_X', 'no_X', 'unclear_or_litigation']);

		function styleByStatus(feature) {
			const status = feature.properties?.status || 'unclear_or_litigation';
			const color = STATUS_COLORS[status] || STATUS_COLORS['unclear_or_litigation'];
			return {
				color: color,
				opacity: 0.8,
				weight: 1,
				fillColor: color,
				fillOpacity: 0.6
			};
		}

		function statusPill(status) {
			const color = STATUS_COLORS[status] || STATUS_COLORS['unclear_or_litigation'];
			return `<span class="pill" style="background:${color}22;border:1px solid ${color}55;color:${color}">${status || 'unknown'}</span>`;
		}

		function onEachFeature(feature, layer) {
			const p = feature.properties || {};
			const allowLabel = p.allow_x === true ? 'Yes' : (p.allow_x === false ? 'No' : 'Unclear');
			const name = p.NAME || p.State_Name || p.State || p.NAME20 || p.name || 'Unknown';
			const notes = (p.notes || '').toString().trim();

			layer.bindPopup(`
        <div class="popup">
          <h3>${name}</h3>
          <div>${statusPill(p.status)}</div>
          <div ><b>Allows “X” on DL:</b> ${allowLabel}</div>
          ${notes ? `<div ><b>Notes:</b> ${escapeHtml(notes)}</div>` : ''}
        </div>
      `);

			layer.on({
				mouseover: (e) => e.target.setStyle({ weight: 2, fillOpacity: 0.9 }),
				mouseout: (e) => statesLayer.resetStyle(e.target),
			});
		}

		function filterFeature(feature) {
			const st = feature.properties?.status || 'unclear_or_litigation';
			return checkedStatuses.has(st);
		}

		function renderLayers(data) {
			if (statesLayer) { statesLayer.remove(); }
			statesLayer = L.geoJSON(data, {
				filter: filterFeature,
				style: styleByStatus,
				onEachFeature
			}).addTo(map);

			buildTable(data);
		}

		function buildTable(data) {
			const tbody = document.querySelector('#dataTable tbody');
			tbody.innerHTML = '';
			const feats = data.features || [];
			for (const f of feats) {
				const p = f.properties || {};
				const st = p.status || 'unclear_or_litigation';
				if (!checkedStatuses.has(st)) continue;
				const allow = p.allow_x === true ? 'Yes' : (p.allow_x === false ? 'No' : 'Unclear');
				const name = p.NAME || p.State_Name || p.State || p.NAME20 || p.name || 'Unknown';
				const tr = document.createElement('tr');
				tr.innerHTML = `<td>${escapeHtml(name)}</td><td>${escapeHtml(st)}</td><td>${allow}</td><td>${escapeHtml(p.notes || '')}</td>`;
				tbody.appendChild(tr);
			}
		}

		function updateDateBadge(data) {
			const feats = data.features || [];
			const dates = feats.map(f => (f.properties?.x_last_checked) || '').filter(Boolean);
			const max = dates.sort().slice(-1)[0] || '—';
			document.getElementById('updatedDate').textContent = max;
		}

		function escapeHtml(str) {
			return String(str).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[s]));
		}

		// Download filtered view as GeoJSON
		function downloadFiltered() {
			if (!currentData) return;
			const filtered = { type: 'FeatureCollection', features: (currentData.features || []).filter(f => filterFeature(f)) };
			const blob = new Blob([JSON.stringify(filtered)], { type: 'application/geo+json' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url; a.download = 'states_x_marker_filtered.geojson';
			document.body.appendChild(a); a.click(); a.remove();
			URL.revokeObjectURL(url);
		}

		// Controls wiring
		document.getElementById('resetBtn').addEventListener('click', () => {
			checkedStatuses.clear();
			['allows_X', 'no_X', 'unclear_or_litigation'].forEach(s => checkedStatuses.add(s));
			document.querySelectorAll('[data-status]').forEach(cb => cb.checked = true);
			renderLayers(currentData);
		});
		document.getElementById('downloadBtn').addEventListener('click', downloadFiltered);

		document.querySelectorAll('[data-status]').forEach(cb => {
			cb.addEventListener('change', (e) => {
				const s = e.target.getAttribute('data-status');
				if (e.target.checked) checkedStatuses.add(s); else checkedStatuses.delete(s);
				renderLayers(currentData);
			});
		});

		// Load GeoJSON
		fetch(GEOJSON_URL)
			.then(r => { if (!r.ok) throw new Error('Failed to fetch GeoJSON'); return r.json(); })
			.then(data => { currentData = data; updateDateBadge(data); renderLayers(data); })
			.catch(err => {
				console.error(err);
				alert('Could not load GeoJSON. Make sure the file is next to this HTML and named:' + GEOJSON_URL);
			});
	</script>
</body>

</html>